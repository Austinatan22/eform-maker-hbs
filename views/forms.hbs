{{!-- views/forms.hbs --}}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Forms</h5>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createFormModal">
      + Create a Form
    </button>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:20%">Title</th>
            <th style="width:15%">Category</th>
            <th style="width:20%">Updated</th>
            <th style="width:20%">Created</th>
            <th class="text-end" style="width:25%">Actions</th>
          </tr>
        </thead>
        <tbody>
          {{#if forms.length}}
            {{#each forms}}
              <tr data-id="{{this.id}}">
                <td class="fw-medium js-title">{{this.title}}</td>
                <td>
                  <div class="btn-group w-100">
                    <button
                      type="button"
                      class="btn btn-sm dropdown-toggle js-cat-btn w-100 d-flex justify-content-between align-items-center"
                      data-bs-toggle="dropdown"
                      data-bs-container="body"
                      data-cat="{{this.category}}"
                      aria-expanded="false">
                      <!-- text filled by script -->
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li><a class="dropdown-item js-cat-opt" data-val="survey" href="javascript:void(0);">Survey</a></li>
                      <li><a class="dropdown-item js-cat-opt" data-val="quiz" href="javascript:void(0);">Quiz</a></li>
                      <li><a class="dropdown-item js-cat-opt" data-val="feedback" href="javascript:void(0);">Feedback</a></li>
                    </ul>
                  </div>
                </td>
                <td><span class="text-muted">{{this.updatedAt}}</span></td>
                <td><span class="text-muted">{{this.createdAt}}</span></td>
                <td class="text-end">
                  <div class="d-inline-flex align-items-center gap-1">
                    <div class="btn-group">
                      <button
                        type="button"
                        class="btn btn-sm btn-icon rounded-pill dropdown-toggle hide-arrow btn-outline-primary js-actions"
                        data-bs-toggle="dropdown"
                        data-bs-container="body"
                        aria-expanded="false"
                        aria-label="Actions">
                        <i class="ti tabler-dots-vertical"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                          <a class="dropdown-item js-act-edit" href="javascript:void(0);">
                            <i class="icon-base ti tabler-edit icon-sm me-2"></i>
                            Edit
                          </a>
                        </li>
                        <li>
                          <a class="dropdown-item js-act-rename" href="javascript:void(0);">
                            <i class="icon-base ti tabler-letter-case icon-sm me-2"></i>
                            Rename
                          </a>
                        </li>
                      </ul>
                    </div>
                    <button type="button" class="btn btn-sm btn-icon btn-outline-danger js-delete" aria-label="Delete">
                      <i class="ti tabler-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            {{/each}}
          {{else}}
            <tr><td colspan="4" class="text-center text-muted py-4">No forms yet.</td></tr>
          {{/if}}
        </tbody>
      </table>
    </div>
  </div>
</div>

{{!-- Create Form wizard modal --}}
<div class="modal fade" id="createFormModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" id="createFormWizard">
      <div class="modal-header">
        <h5 class="modal-title js-wiz-title">Create a Form</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="js-step" data-step="choose">
          <p class="text-muted mb-3">How would you like to start?</p>
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-primary js-choose-blank">
              Create a blank form
            </button>
            <button type="button" class="btn btn-outline-secondary js-choose-template">
              Start from a template
            </button>
          </div>
        </div>

        <div class="js-step d-none" data-step="blank">
          <div class="mb-3">
            <label class="form-label" for="blankTitle">Form Name</label>
            <input id="blankTitle" type="text" class="form-control" placeholder="e.g. Contact Us" required>
          </div>
          <div>
            <label class="form-label" for="blankCategory">Category</label>
            <select id="blankCategory" class="form-select">
              <option value="survey" selected>Survey</option>
              <option value="quiz">Quiz</option>
              <option value="feedback">Feedback</option>
            </select>
          </div>
        </div>

        <div class="js-step d-none" data-step="templates">
          <p class="text-muted">Pick a template</p>
          <div class="list-group">
            <label class="list-group-item d-flex align-items-center">
              <input class="form-check-input me-2" type="radio" name="templateChoice" value="newsletter">
              <span class="fw-medium">Newsletter Signup</span>
            </label>
            <label class="list-group-item d-flex align-items-center">
              <input class="form-check-input me-2" type="radio" name="templateChoice" value="complaints">
              <span class="fw-medium">Complaints</span>
            </label>
            <label class="list-group-item d-flex align-items-center">
              <input class="form-check-input me-2" type="radio" name="templateChoice" value="profile">
              <span class="fw-medium">Profile</span>
            </label>
            <label class="list-group-item d-flex align-items-center">
              <input class="form-check-input me-2" type="radio" name="templateChoice" value="rsvp">
              <span class="fw-medium">Event RSVP</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary js-wiz-back d-none">Back</button>
        <button type="button" class="btn btn-primary js-wiz-next">Next</button>
      </div>
    </div>
  </div>
  </div>

{{#section 'scripts'}}
<script>
(function() {
  function catBtnClass(cat) {
    switch ((cat || '').toLowerCase()) {
      case 'quiz': return 'btn-label-info';
      case 'feedback': return 'btn-label-warning';
      default: return 'btn-label-primary';
    }
  }

  function catLabel(cat) {
    const v = String(cat || 'survey').toLowerCase();
    if (v === 'quiz') return 'Quiz';
    if (v === 'feedback') return 'Feedback';
    return 'Survey';
  }

  // Initialize category label buttons
  document.querySelectorAll('tr[data-id]').forEach(row => {
    const btn = row.querySelector('.js-cat-btn');
    if (!btn) return;
    const cat = btn.getAttribute('data-cat') || 'survey';
    // Button content: label on left, caret handled by dropdown-toggle
    btn.textContent = catLabel(cat);
    btn.classList.add(catBtnClass(cat));
    // Ensure dropdown doesn't cause parent overflow by using fixed strategy
    try {
      // Recreate/attach a dropdown with Popper fixed strategy and viewport boundary
      const dd = bootstrap.Dropdown.getOrCreateInstance(btn, {
        boundary: 'viewport',
        popperConfig(config) {
          return Object.assign({}, config || {}, { strategy: 'fixed' });
        }
      });
      // no-op reference to keep linter happy
      void dd;
    } catch (_) { /* ignore */ }
  });

  // Initialize kebab action dropdowns with fixed strategy
  document.querySelectorAll('.js-actions').forEach(btn => {
    try {
      const dd = bootstrap.Dropdown.getOrCreateInstance(btn, {
        boundary: 'viewport',
        popperConfig(config) {
          return Object.assign({}, config || {}, { strategy: 'fixed' });
        }
      });
      void dd;
    } catch (_) { /* ignore */ }
  });

  // Create Form wizard logic
  (function initCreateFormWizard(){
    const modalEl = document.getElementById('createFormModal');
    const wiz = document.getElementById('createFormWizard');
    if (!modalEl || !wiz) return;

    const stepChoose = wiz.querySelector('[data-step="choose"]');
    const stepBlank = wiz.querySelector('[data-step="blank"]');
    const stepTpl = wiz.querySelector('[data-step="templates"]');
    const btnBack = wiz.querySelector('.js-wiz-back');
    const btnNext = wiz.querySelector('.js-wiz-next');
    const titleEl = wiz.querySelector('.js-wiz-title');
    const inputTitle = wiz.querySelector('#blankTitle');
    const selCat = wiz.querySelector('#blankCategory');

    let mode = 'choose'; // 'choose' | 'blank' | 'templates'

    const TEMPLATES = {
      newsletter: {
        name: 'Newsletter Signup',
        category: 'survey',
        fields: [
          { type: 'name', label: 'Full Name', name: 'fullName', placeholder: '', required: true },
          { type: 'email', label: 'Email', name: 'email', placeholder: 'you@example.com', required: true }
        ]
      },
      complaints: {
        name: 'Complaints',
        category: 'feedback',
        fields: [
          { type: 'name', label: 'Full Name', name: 'fullName', placeholder: '' },
          { type: 'email', label: 'Email', name: 'email', placeholder: 'you@example.com' },
          { type: 'dropdown', label: 'Issue Type', name: 'issueType', options: 'Billing,Bug,Feature Request,Other', required: true },
          { type: 'paragraph', label: 'Describe the issue', name: 'details', placeholder: 'Tell us what went wrong...', required: true }
        ]
      },
      profile: {
        name: 'Profile',
        category: 'survey',
        fields: [
          { type: 'name', label: 'Full Name', name: 'fullName', placeholder: '', required: true },
          { type: 'email', label: 'Email', name: 'email', placeholder: 'you@example.com' },
          { type: 'phone', label: 'Phone Number', name: 'phone', placeholder: '' }
        ]
      },
      rsvp: {
        name: 'Event RSVP',
        category: 'survey',
        fields: [
          { type: 'name', label: 'Full Name', name: 'fullName', placeholder: '', required: true },
          { type: 'email', label: 'Email', name: 'email', placeholder: 'you@example.com' },
          { type: 'multipleChoice', label: 'Attending?', name: 'attending', options: 'Yes,No', required: true },
          { type: 'number', label: 'Guests', name: 'guests', placeholder: '0' }
        ]
      }
    };

    function show(step){
      mode = step;
      stepChoose.classList.toggle('d-none', step !== 'choose');
      stepBlank.classList.toggle('d-none', step !== 'blank');
      stepTpl.classList.toggle('d-none', step !== 'templates');
      btnBack.classList.toggle('d-none', step === 'choose');
      btnNext.textContent = (step === 'choose') ? 'Next' : 'Create';
      titleEl.textContent = 'Create a Form';
    }

    wiz.querySelector('.js-choose-blank')?.addEventListener('click', () => show('blank'));
    wiz.querySelector('.js-choose-template')?.addEventListener('click', () => show('templates'));

    btnBack?.addEventListener('click', () => show('choose'));

    btnNext?.addEventListener('click', async () => {
      try {
        if (mode === 'blank') {
          const title = (inputTitle?.value || '').trim();
          if (!title) { inputTitle?.focus(); return; }
          const category = selCat?.value || 'survey';
          const res = await fetch('/api/forms', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, category, fields: [] })
          });
          const out = await res.json();
          if (!res.ok || !out?.form?.id) throw new Error(out?.error || 'Create failed');
          bootstrap.Modal.getInstance(modalEl)?.hide();
          window.location.assign('/builder/' + out.form.id);
          return;
        }

        if (mode === 'templates') {
          const selected = wiz.querySelector('input[name="templateChoice"]:checked');
          if (!selected) return;
          const key = selected.value;
          const tpl = TEMPLATES[key];
          const payload = { title: tpl.name, category: tpl.category, fields: tpl.fields };
          const res = await fetch('/api/forms', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const out = await res.json();
          if (!res.ok || !out?.form?.id) throw new Error(out?.error || 'Create failed');
          bootstrap.Modal.getInstance(modalEl)?.hide();
          window.location.assign('/builder/' + out.form.id);
          return;
        }

        // From choose -> go to blank as default
        show('blank');
      } catch (err) {
        console.error(err);
        alert(err?.message || 'Could not create form.');
      }
    });

    // Reset wizard on open
    modalEl.addEventListener('show.bs.modal', () => {
      wiz.querySelector('input[name="templateChoice"]:checked')?.closest('label')?.classList.remove('active');
      const checked = wiz.querySelector('input[name="templateChoice"]:checked');
      if (checked) checked.checked = false;
      inputTitle && (inputTitle.value = '');
      selCat && (selCat.value = 'survey');
      show('choose');
    });
  })();

  // Row actions (delete, category change via dropdown)
  document.querySelector('table')?.addEventListener('click', async (e) => {
    const btn = e.target.closest('.js-delete');
    if (btn) {
      const row = btn.closest('tr');
      const id = row?.dataset.id;
      if (!id) return;
      const title = (row.querySelector('.js-title')?.textContent || '').trim();
      const modalEl = document.getElementById('confirmDeleteModal');
      modalEl.dataset.id = id;
      modalEl.querySelector('.js-del-title').textContent = title || 'this form';
      const m = bootstrap.Modal.getOrCreateInstance(modalEl);
      m.show();
      return;
    }
    // Category option click
    const opt = e.target.closest('.js-cat-opt');
    if (opt) {
      const row = opt.closest('tr');
      const id = row?.dataset.id;
      const val = opt.getAttribute('data-val') || 'survey';
      const btnCat = row.querySelector('.js-cat-btn');
      try {
        const res = await fetch('/api/forms/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category: val })
        });
        if (!res.ok) throw new Error('Update failed');
        // Update button text and class
        btnCat?.setAttribute('data-cat', val);
        if (btnCat) {
          btnCat.textContent = catLabel(val);
          btnCat.classList.remove('btn-label-primary','btn-label-info','btn-label-warning');
          btnCat.classList.add(catBtnClass(val));
        }
      } catch (err) {
        console.error(err);
        alert('Could not update category');
      }
      return;
    }

    // Edit action
    const actEdit = e.target.closest('.js-act-edit');
    if (actEdit) {
      const row = actEdit.closest('tr');
      const id = row?.dataset.id;
      if (!id) return;
      window.location.assign('/builder/' + id);
      return;
    }

    // Rename action
    const actRename = e.target.closest('.js-act-rename');
    if (actRename) {
      const row = actRename.closest('tr');
      const id = row?.dataset.id;
      if (!id) return;
      const titleCell = row.querySelector('.js-title');
      const current = (titleCell?.textContent || '').trim();
      const modalEl = document.getElementById('renameFormModal');
      modalEl.dataset.id = id;
      const input = modalEl.querySelector('#renameFormInput');
      input.value = current;
      const m = bootstrap.Modal.getOrCreateInstance(modalEl);
      m.show();
      return;
    }
  });

  // Delete modal confirm
  document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
    const modalEl = document.getElementById('confirmDeleteModal');
    const id = modalEl?.dataset.id;
    if (!id) return;
    const row = document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
    try {
      const res = await fetch('/api/forms/' + id, { method: 'DELETE' });
      if (!res.ok) throw new Error('Delete failed');
      row?.remove();
      bootstrap.Modal.getInstance(modalEl)?.hide();
    } catch (err) {
      console.error(err);
      alert('Could not delete form.');
    }
  });

  // Rename modal submit
  document.getElementById('renameFormForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const modalEl = document.getElementById('renameFormModal');
    const id = modalEl?.dataset.id;
    if (!id) return;
    const input = document.getElementById('renameFormInput');
    const newTitle = String(input.value || '').trim();
    if (!newTitle) return;
    const row = document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
    const titleCell = row?.querySelector('.js-title');
    try {
      const res = await fetch('/api/forms/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: newTitle })
      });
      const out = await res.json().catch(() => ({}));
      if (!res.ok) {
        if (res.status === 409) throw new Error('Title already exists.');
        throw new Error(out?.error || 'Update failed');
      }
      if (titleCell) titleCell.textContent = newTitle;
      bootstrap.Modal.getInstance(modalEl)?.hide();
    } catch (err) {
      console.error(err);
      alert(err?.message || 'Could not rename form');
    }
  });
})();
</script>
{{/section}}

{{!-- Rename Form modal --}}
<div class="modal fade" id="renameFormModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" id="renameFormForm">
      <div class="modal-header">
        <h5 class="modal-title">Rename form</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label class="form-label" for="renameFormInput">New name</label>
        <input id="renameFormInput" type="text" class="form-control" placeholder="Enter new form name" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
  </div>

{{!-- Delete Confirm modal --}}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete form</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong class="js-del-title">this form</strong>? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" id="confirmDeleteBtn" type="button">Delete</button>
      </div>
    </div>
  </div>
  </div>
